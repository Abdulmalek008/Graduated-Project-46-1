import streamlit as st
import pandas as pd
import numpy as np
from sklearn.ensemble import RandomForestRegressor
from sklearn.model_selection import train_test_split
from sklearn.metrics import mean_absolute_error

# Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
st.title('ğŸ“ Student Final Score Prediction App')

st.info('This app predicts the final score of students based on their performance scores.')

# ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
with st.expander('ğŸ“Š Dataset'):
    # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    df = pd.read_csv('https://raw.githubusercontent.com/Abdulmalek008/Graduated-Project-46-1/refs/heads/master/Student_Info%202.csv')
    
    # Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙˆØ¯ ØºÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    df.drop(columns=['Total'], inplace=True)
    
    # Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    st.write('### Raw Data:')
    st.dataframe(df)

# ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ¹Ù„Ù… Ø§Ù„Ø¢Ù„ÙŠ
with st.expander('âš™ï¸ Data Preparation'):
    # ØªØ±Ù…ÙŠØ² Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¬Ù†Ø³
    df_encoded = pd.get_dummies(df, columns=['Gender'], drop_first=True)
    
    # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Øª ÙˆØ§Ù„Ù‡Ø¯Ù
    X = df_encoded.drop(columns=['Final_Score', 'Level', 'Student_ID'])  # Ø§Ø³ØªØ®Ø¯Ø§Ù… Final_Score ÙƒÙ‡Ø¯Ù
    y = df['Final_Score']  # Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø¢Ù† Ù‡Ùˆ Final_Score
    
    st.write('### Features (X):')
    st.dataframe(X)
    st.write('### Target (y):')
    st.dataframe(y)

# ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.3, random_state=42)

# ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
model = RandomForestRegressor(random_state=42)
model.fit(X_train, y_train)

# ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
y_pred = model.predict(X_test)
mae = mean_absolute_error(y_test, y_pred)
st.write(f"### Mean Absolute Error (MAE): {mae:.2f}")

# ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
with st.sidebar:
    st.header('ğŸ” Enter Student Data:')
    gender = st.selectbox('Gender', ['Male', 'Female'])
    attendance_score = st.slider('Attendance Score', 0, 5, 3)
    mid_exam_score = st.slider('Mid Exam Score', 0, 15, 10)
    lab_exam_score = st.slider('Lab Exam Score', 0, 15, 10)
    activity_score = st.slider('Activity Score', 0, 25, 15)

# Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù† Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„ÙŠØ¯ÙˆÙŠØ© Ù„Ø§ ÙŠØªØ¬Ø§ÙˆØ² 60
manual_score = attendance_score + mid_exam_score + lab_exam_score + activity_score
if manual_score == 60:
    st.warning(f"Note: The sum of manual scores (attendance, mid exam, lab exam, and activity) is exactly 60. Current sum: {manual_score}")
else:
    st.write(f"Total of manual scores: {manual_score} (does not need to be exactly 60)")

# Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© (Final Exam Score) Ø³ØªÙƒÙˆÙ† Ù…Ù† 40
final_exam_score = st.slider('Final Exam Score', 0, 40, 20)

# ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
new_data = pd.DataFrame({
    'Attendance_Score': [attendance_score],
    'Mid_Exam_Score': [mid_exam_score],
    'Lab_Exam_Score': [lab_exam_score],
    'Activity_Score': [activity_score],
    'Final_Score': [final_exam_score],
    'Gender_Male': [1 if gender == 'Male' else 0]
})

# Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù…Ø¹ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
new_data = new_data.reindex(columns=X.columns, fill_value=0)

# Ø§Ù„ØªÙ†Ø¨Ø¤ Ø¨Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
predicted_score = model.predict(new_data)

# Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
st.write(f"The predicted final score for the student is: **{predicted_score[0]:.2f}**")

# Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø© ÙˆØ§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©
input_data = {
    'Gender': [gender],
    'Attendance Score': [attendance_score],
    'Mid Exam Score': [mid_exam_score],
    'Lab Exam Score': [lab_exam_score],
    'Activity Score': [activity_score],
    'Final Exam Score': [final_exam_score],
    'Predicted Final Score': [predicted_score[0]]
}

input_df = pd.DataFrame(input_data)

with st.expander('ğŸ“Š Prediction Table'):
    st.write('### Entered Data and Predicted Final Score:')
    st.dataframe(input_df)

# Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ ÙŠÙˆØ¶Ø­ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
with st.expander('ğŸ“Š Final Score Distribution'):
    st.write('### Distribution of Final Scores:')
    st.bar_chart(df['Final_Score'])
